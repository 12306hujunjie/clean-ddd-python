# CLAUDE.md

本文件为 Claude Code (claude.ai/code) 在此代码仓库中工作时提供指导。

## 项目目标

本仓库旨在创建Python Clean DDD（领域驱动设计）实践的综合指导文档。项目专注于**分层思维**——使用不同层次来解决不同类型的问题。

## 核心DDD原则

### 1. **按层分离关注点**
- 每一层应该解决其特定抽象级别的问题
- 领域层：纯业务逻辑和规则
- 应用层：用例编排和协调
- 基础设施层：技术实现细节
- 表现层：外部接口适配

### 2. **依赖方向**
- 依赖指向内层：表现层 → 应用层 → 领域层
- 内层独立于外层
- 对基础设施关注点使用依赖倒置

### 3. **Python特定考虑**
- 充分利用Python优势：async/await、dataclasses、类型提示、上下文管理器
- 明智使用Python生态：SQLAlchemy、Pydantic、FastAPI、Celery
- 保持Python简洁和可读性的哲学
- 避免过度工程——从简单开始，逐步演化

## 协助DDD文档编写时的重点

### **关注领域**
1. **清晰的层边界**：始终强调每一层解决什么问题
2. **Python惯用法**：展示如何用Python自然地表达DDD概念
3. **实用示例**：提供具体、可运行的代码示例
4. **渐进复杂性**：从简单模式开始，构建到复杂场景
5. **现实情境**：将抽象概念连接到实际业务问题

### **需要涵盖的核心DDD元素**

#### **Clean DDD核心要素（基于参考博文）**
- **聚合(Aggregate)**：数据修改的基本单元，维护业务不变性
- **实体(Entity)**：系统中的关键对象，具有唯一标识
- **值类型(Value Types)**：系统中的基本类型，不可变的业务概念
- **领域事件(Domain Events)**：聚合间通信的机制，实现解耦
- **命令(Commands)**：操作意图的表达，触发业务行为
- **查询(Queries)**：数据获取的方式，只读操作
- **控制器(Controllers)**：外部接口的处理，协调应用逻辑

#### **Clean DDD关键原则**
1. **聚合不相互引用** - 聚合之间通过ID关联，不直接持有引用
2. **一个命令仅操作一个聚合** - 保持操作的原子性和一致性
3. **聚合不共享实体** - 每个实体只属于一个聚合
4. **聚合间通过事件传递影响** - 异步解耦的协作方式

#### **Python实现重点**
- **聚合根设计**：如何在Python中实现聚合边界和一致性
- **值对象实现**：使用dataclasses创建不可变业务概念
- **领域事件系统**：基于Python的发布-订阅模式
- **命令查询分离**：清晰的读写操作分离
- **仓储模式**：数据访问的抽象层
- **应用服务编排**：用例的协调和组织

### **Python技术栈偏好**
- **Web框架**：FastAPI（支持异步的API）
- **ORM**：SQLAlchemy（支持异步）
- **验证**：Pydantic（数据验证和序列化）
- **任务队列**：Celery（后台处理和事件）
- **测试**：pytest（不同层的fixtures）
- **类型检查**：mypy（静态分析）
- **依赖注入**：dependency-injector或简单工厂模式

### **文档结构指导原则**
1. 从要解决的业务问题开始
2. 首先展示领域模型（实体、值对象、聚合）
3. 演示应用层协调
4. 解释基础设施实现
5. 展示表现层适配器
6. 包含每层的测试策略
7. 提供迁移/演化策略

### **需要避免的常见陷阱**
- 不要对简单问题过度工程化
- 不要混合业务逻辑与技术关注点
- 不要跳过领域建模阶段
- 不要忽视Python的优势（异步、类型提示等）
- 不要创建不必要的抽象
- 不要违反层依赖关系

### **讨论实现时**
- 始终从"这解决什么问题？"开始
- 展示概念和Python实现
- 解释为什么这种方法适合Python生态系统
- 为不同复杂性级别提供替代方案
- 包含实用考虑（性能、可维护性）

## 文件组织

- `README.md`：主要项目概述和架构设计
- `docs/`：每个DDD元素的详细文档
- `examples/`：每个模式的具体代码示例
- `tests/`：每层的示例测试策略

## 开发命令

项目演化时，应记录这些命令：
- **测试**：`pytest`
- **类型检查**：`mypy`
- **代码检查**：`ruff check`
- **文档**：`mkdocs serve`（如果使用mkdocs）